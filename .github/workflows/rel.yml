name: Aggregated aarch64 Deb Packages Release

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    if: ${{ github.repository_owner == 'aikwp' && github.event.repository.name == 'Serom' }}
    steps:
      - name: Fetch .deb assets directly from existing releases
        run: |
          set -euxo pipefail
          mkdir -p release-assets
          wget https://github.com/aikwp/Serom/releases/download/v3.13.9-aarch64/pyv_3.13.9_aarch64.deb
          wget https://github.com/aikwp/Serom/releases/download/v3.14.0-aarch64/pyv_3.14.0_aarch64.deb
          wget https://github.com/aikwp/Serom/releases/download/v3.15.0a1-aarch64/pyv_3.15.0a1_aarch64.deb
              
      - name: Validate .deb package integrity
        run: |
          set -euo pipefail
          for deb in release-assets/*.deb; do
            echo "Validating $deb"
            dpkg-deb --info "$deb" > /dev/null
            dpkg-deb --contents "$deb" > /dev/null
            echo "Valid: $deb"
          done

      - name: Extract metadata for release notes
        id: meta
        run: |
          set -euo pipefail
          versions=()
          for f in release-assets/*.deb; do
            ver=$(basename "$f" | sed -E 's/pyv_([0-9a\.]+)_aarch64\.deb/\1/')
            versions+=("$ver")
          done
          latest=$(printf '%s\n' "${versions[@]}" | sort -V | tail -n1)
          count=${#versions[@]}
          list=$(IFS=', '; echo "${versions[*]}")
          echo "latest=$latest" >> "$GITHUB_OUTPUT"
          echo "count=$count" >> "$GITHUB_OUTPUT"
          echo "list=$list" >> "$GITHUB_OUTPUT"

      - name: Create or update aggregated release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: aarch64-aggregated
          name: Aggregated Termux Python Builds (aarch64)
          body: |
            Consolidated release containing all current Termux-compatible Python .deb packages.
            **Versions included** (${{ steps.meta.outputs.count }}):
            ${{ steps.meta.outputs.list }}
            **Latest**: ${{ steps.meta.outputs.latest }}
            **NDK**: r27
            **Architecture**: aarch64
            **Source**: Directly fetched from per-version releases
            **Commit**: ${{ github.sha }}
            **Run**: ${{ github.run_id }}
            Built and aggregated automatically by GitHub Actions.
          files: |
            release-assets/**.deb
          fail_on_unmatched_files: false
          overwrite_files: true
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
